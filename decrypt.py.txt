#!/usr/bin/env python3
import os
import json
from base64 import b64decode
from Cryptodome.Cipher import AES, PKCS1_OAEP
from Cryptodome.PublicKey import RSA

def decrypt_file_with_rsa_priv(enc_path, rsa_priv):
    with open(enc_path, "r") as f:
        payload = json.load(f)

    encrypted_key = b64decode(payload["encrypted_key"])
    nonce = b64decode(payload["nonce"])
    ciphertext = b64decode(payload["ciphertext"])

    # recover AES key
    rsa_cipher = PKCS1_OAEP.new(rsa_priv)
    aes_key = rsa_cipher.decrypt(encrypted_key)

    # decrypt file
    cipher_aes = AES.new(aes_key, AES.MODE_CTR, nonce=nonce)
    plaintext = cipher_aes.decrypt(ciphertext)

    out_path = enc_path.replace(".enc", ".dec")
    with open(out_path, "wb") as f:
        f.write(plaintext)

    print(f"Decrypted: {enc_path} -> {out_path}")

def main():
    priv_path = input("Path to RSA private key (e.g. private.pem): ").strip()
    folder = input("Directory containing .enc files: ").strip()

    with open(priv_path, "rb") as f:
        rsa_priv = RSA.import_key(f.read())

    for root, _, files in os.walk(folder):
        for name in files:
            if not name.endswith(".enc"):
                continue
            enc_path = os.path.join(root, name)
            try:
                decrypt_file_with_rsa_priv(enc_path, rsa_priv)
            except Exception as e:
                print(f"Failed to decrypt {enc_path}: {e}")

if __name__ == "__main__":
    main()