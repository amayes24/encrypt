#!/usr/bin/env python3
import os, json, base64, argparse, tarfile, tempfile
from Crypto.Cipher import AES
from Crypto.Random import get_random_bytes
import getpass

def make_tar(src_dir, out_path):
    """Create a tar.gz archive from a directory."""
    with tarfile.open(out_path, "w:gz") as tar:
        tar.add(src_dir, arcname=os.path.basename(src_dir))

def encrypt_file(input_path, output_path, key):
    """Encrypt a file using AES-CTR and save nonce + ciphertext as JSON."""
    cipher = AES.new(key, AES.MODE_CTR)
    with open(input_path, "rb") as f:
        plaintext = f.read()
    ciphertext = cipher.encrypt(plaintext)

    result = {
        "nonce": base64.b64encode(cipher.nonce).decode("utf-8"),
        "ciphertext": base64.b64encode(ciphertext).decode("utf-8")
    }

    with open(output_path, "w") as out:
        json.dump(result, out, indent=4)

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("dir", help="Directory to encrypt")
    parser.add_argument("out", help="Output encrypted JSON file (e.g. secret.enc.json)")
    args = parser.parse_args()

    password = getpass.getpass("Enter passphrase: ").encode()
    key = password.ljust(16, b'\0')[:16]  # pad or truncate to 16 bytes (AES-128)

    # Create temporary tar.gz archive of the directory
    with tempfile.NamedTemporaryFile(suffix=".tar.gz", delete=False) as tmp:
        tar_path = tmp.name

    make_tar(args.dir, tar_path)
    encrypt_file(tar_path, args.out, key)
    os.remove(tar_path)
    print(f"âœ… Encrypted directory '{args.dir}' to '{args.out}'")

if __name__ == "__main__":
    main()
